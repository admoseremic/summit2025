<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Leaderboard with Total Points</title>
    <!-- Firebase libraries for non-modular version (compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* Default styles for the background */
        body {
            transition: background-color 0.5s ease;
        }

        /* Styles for the leaderboard */
        #leaderboard {
            margin-top: 20px;
        }

        #leaderboard ul {
            list-style-type: none;
            padding: 0;
        }

        #leaderboard li {
            padding: 5px;
            margin: 5px 0;
            background-color: #f0f0f0;
        }

        /* Styles for the game area */
        #gameContainer {
            width: 600px;
            height: 400px;
            border: 2px solid #000;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>Enter Your Name</h1>

    <!-- Simple Form for Name Entry -->
    <form id="nameForm" onsubmit="submitName(event)">
        <label for="username">Your Name:</label>
        <input type="text" id="username" placeholder="Enter your name" required>
        <button type="submit">Submit</button>
    </form>

    <p id="message"></p>

    <!-- Display the user's total points -->
    <h2>Your Total Points: <span id="totalPoints">0</span></h2>

    <!-- Leaderboard for the current game -->
    <div id="leaderboard">
        <h2 id="leaderboardTitle">Leaderboard</h2>
        <ul id="leaderboardList">
            <!-- Leaderboard entries will be dynamically inserted here -->
        </ul>
    </div>

    <!-- Game container -->
    <div id="gameContainer">
        <h3 id="gameTitle">Select a game to play...</h3>
        <div id="gameContent"></div>
    </div>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCzNlR44to_EjL0umFtg2MI5S549phbKRc",
            authDomain: "summit-games-a1f9f.firebaseapp.com",
            databaseURL: "https://summit-games-a1f9f-default-rtdb.firebaseio.com/",
            projectId: "summit-games-a1f9f",
            storageBucket: "summit-games-a1f9f.appspot.com",
            messagingSenderId: "441105165656",
            appId: "1:441105165656:web:277897c92f13365a98092d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Function to handle form submission
        function submitName(event) {
            event.preventDefault();  // Prevent form refresh
            const username = document.getElementById('username').value;

            if (username) {
                // Save username to localStorage to persist across sessions
                localStorage.setItem('username', username);

                // Use `push()` to generate a unique ID for each attendee
                const newAttendeeRef = db.ref('attendees').push();

                // Write the user's name and example scores to the Realtime Database
                newAttendeeRef.set({
                    name: username,
                    pacman: 50,         // Example scores
                    donkeykong: 100,
                    spaceinvaders: 75,
                    frogger: 90
                })
                .then(() => {
                    document.getElementById('message').innerText = 'Name submitted successfully!';
                    // After name is submitted, start listening for real-time updates
                    listenForGameChanges();
                    listenForUserTotalPoints(username);
                })
                .catch(error => {
                    document.getElementById('message').innerText = 'Error submitting name: ' + error.message;
                });
            }
        }

        // Function to update game based on the current game
        function updateGame(game) {
            const gameTitle = document.getElementById('gameTitle');
            const gameContent = document.getElementById('gameContent');
            gameContent.innerHTML = ''; // Clear previous game content

            // Remove any previously added game script
            const oldScript = document.getElementById('gameScript');
            if (oldScript) {
                oldScript.remove();
            }

            let scriptSrc = '';

            switch (game) {
                case 'pacman':
                    gameTitle.innerText = 'Pac-Man';
                    gameContent.innerHTML = '<div id="pacmanGame">Stubbed out version of Pac-Man goes here!</div>';
                    scriptSrc = 'pacman.js';
                    break;
                case 'donkeykong':
                    gameTitle.innerText = 'Donkey Kong';
                    gameContent.innerHTML = '<div id="donkeyKongGame">Stubbed out version of Donkey Kong goes here!</div>';
                    scriptSrc = 'donkeykong.js';
                    break;
                case 'frogger':
                    gameTitle.innerText = 'Frogger';
                    gameContent.innerHTML = '<div id="froggerGame">Stubbed out version of Frogger goes here!</div>';
                    scriptSrc = 'frogger.js';
                    break;
                case 'spaceinvaders':
                    gameTitle.innerText = 'Space Invaders';
                    gameContent.innerHTML = '<div id="spaceInvadersGame">Stubbed out version of Space Invaders goes here!</div>';
                    scriptSrc = 'spaceinvaders.js';
                    break;
                default:
                    gameTitle.innerText = 'Select a game to play...';
                    gameContent.innerHTML = '<p>Please select a game from the list above.</p>';
            }

            if (scriptSrc) {
                // Create a new script element for the current game
                const script = document.createElement('script');
                script.src = scriptSrc;
                script.id = 'gameScript';
                document.body.appendChild(script);
            }
        }

        // Function to retrieve and update the leaderboard for the current game
        function updateLeaderboard(currentGame) {
            const leaderboardTitle = document.getElementById('leaderboardTitle');
            const leaderboardList = document.getElementById('leaderboardList');

            leaderboardTitle.innerText = currentGame.charAt(0).toUpperCase() + currentGame.slice(1) + " Leaderboard";

            // Fetch all users and their scores for the current game
            db.ref('attendees').on('value', (snapshot) => {
                const attendees = snapshot.val();
                const scores = [];

                // Loop through attendees and get scores for the current game
                for (let key in attendees) {
                    if (attendees.hasOwnProperty(key)) {
                        const user = attendees[key];
                        scores.push({ name: user.name, score: user[currentGame] || 0 });
                    }
                }

                // Sort the scores in descending order
                scores.sort((a, b) => b.score - a.score);

                // Clear existing leaderboard
                leaderboardList.innerHTML = '';

                // Display sorted scores on the leaderboard
                scores.forEach((user) => {
                    const li = document.createElement('li');
                    li.innerText = `${user.name}: ${user.score} points`;
                    leaderboardList.appendChild(li);
                });
            });
        }

        // Listen for real-time changes to the current game and update the leaderboard
        function listenForGameChanges() {
            const gameRef = db.ref('currentGame');
            gameRef.on('value', (snapshot) => {
                const currentGame = snapshot.val();
                updateGame(currentGame);
                updateLeaderboard(currentGame);  // Update leaderboard for the current game
            });
        }

        // Listen for real-time changes to the user's total points
        function listenForUserTotalPoints(username) {
            db.ref('attendees').on('value', (snapshot) => {
                const attendees = snapshot.val();
                for (let key in attendees) {
                    if (attendees.hasOwnProperty(key) && attendees[key].name === username) {
                        const user = attendees[key];
                        const totalPoints = (user.pacman || 0) + (user.donkeykong || 0) + (user.spaceinvaders || 0) + (user.frogger || 0);
                        document.getElementById('totalPoints').innerText = totalPoints;
                        break;
                    }
                }
            });
        }

        // Check if a username is stored in localStorage and pre-fill the form
        window.onload = function() {
            const storedName = localStorage.getItem('username');
            if (storedName) {
                document.getElementById('username').value = storedName;
                document.getElementById('message').innerText = `Welcome back, ${storedName}!`;

                // Start real-time listener for current game and leaderboard
                listenForGameChanges();
                listenForUserTotalPoints(storedName);
            }
        };
    </script>

</body>
</html>